name: Python ä»£ç è´¨é‡ä¸å®‰å…¨å®¡æŸ¥æµæ°´çº¿

on:
  pull_request:

jobs:
  security-check:
    name: "å®‰å…¨ä¸è´¨é‡å®¡æŸ¥ï¼ˆPythonï¼‰"
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    # ==================== åˆå§‹åŒ–é˜¶æ®µ ====================
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ==================== é…ç½®å‡†å¤‡é˜¶æ®µ ====================
    - name: åŠ è½½æ£€æŸ¥è§„åˆ™
      run: |
        mkdir -p .github/linters
        [ -f .github/linters/flake8 ] || touch .github/linters/flake8
        ln -sf .github/linters/flake8 .flake8
        ln -sf .github/linters/mypy.ini mypy.ini
        ln -sf .github/linters/pyproject.toml pyproject.toml

    # ==================== ç¯å¢ƒè®¾ç½®é˜¶æ®µ ====================
    - name: é…ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei jq

    - name: å®‰è£…åˆ†æå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black mypy safety bandit \
                  pip-licenses trufflehog3 matplotlib \
                  pandas coscmd
        pip install -r requirements.txt

    # ==================== ä»£ç è´¨é‡å®¡æŸ¥é˜¶æ®µ ====================
    - name: æ‰§è¡Œä»£ç è§„èŒƒæ£€æŸ¥
      run: |
        flake8 . --config .flake8
        black --check . --config pyproject.toml
        mypy . --config-file mypy.ini

    # ==================== å®‰å…¨å®¡æŸ¥é˜¶æ®µ ====================
    - name: æ‰§è¡Œå®‰å…¨æ‰«æ
      run: |
        pip freeze | safety check --stdin --output json > safety.json
        bandit -r . -f json -o bandit.json
        trufflehog3 filesystem --directory . --json > trufflehog.json
        pip-licenses --format=json > licenses.json

    # ==================== å®‰å…¨è¯„åˆ†ç³»ç»Ÿ ====================
    - name: è®¡ç®—å®‰å…¨è¯„åˆ†
      id: security-scoring
      run: |
        # æƒé‡é…ç½®
        SAFETY_WEIGHT=10
        HIGH_RISK_WEIGHT=8
        MEDIUM_RISK_WEIGHT=5
        LOW_RISK_WEIGHT=2
        SECRETS_WEIGHT=20
        LICENSE_WEIGHT=3

        # æ•°æ®é‡‡é›†
        SAFETY_ISSUES=$(jq '.vulnerabilities | length' safety.json)
        HIGH_RISK_ISSUES=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit.json)
        MEDIUM_RISK_ISSUES=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit.json)
        LOW_RISK_ISSUES=$(jq '[.results[] | select(.issue_severity == "LOW")] | length' bandit.json)
        SECRETS_FOUND=$(jq 'length' trufflehog.json)
        LICENSE_ISSUES=$(jq 'map(select(.License | test("MIT|Apache|BSD") | not)) | length' licenses.json)

        # è®¡ç®—é€»è¾‘
        TOTAL_DEDUCTION=$((SAFETY_ISSUES*SAFETY_WEIGHT + HIGH_RISK_ISSUES*HIGH_RISK_WEIGHT + 
                          MEDIUM_RISK_ISSUES*MEDIUM_RISK_WEIGHT + LOW_RISK_ISSUES*LOW_RISK_WEIGHT + 
                          SECRETS_FOUND*SECRETS_WEIGHT + LICENSE_ISSUES*LICENSE_WEIGHT))

        FINAL_SCORE=$((100 - TOTAL_DEDUCTION))
        FINAL_SCORE=$((FINAL_SCORE < 0 ? 0 : FINAL_SCORE))

        # è¯„çº§ç³»ç»Ÿ
        if (( FINAL_SCORE >= 90 )); then RATING="ğŸŸ¢ â˜…â˜…â˜…â˜…â˜…"
        elif (( FINAL_SCORE >= 75 )); then RATING="ğŸŸ¢ â˜…â˜…â˜…â˜…â˜†"
        elif (( FINAL_SCORE >= 60 )); then RATING="ğŸŸ¡ â˜…â˜…â˜…â˜†â˜†"
        elif (( FINAL_SCORE >= 40 )); then RATING="ğŸŸ  â˜…â˜…â˜†â˜†â˜†"
        else RATING="ğŸ”´ â˜…â˜†â˜†â˜†â˜†"; fi

        # è¾“å‡ºå˜é‡
        echo "SECURITY_SCORE=$FINAL_SCORE" >> $GITHUB_ENV
        echo "SECURITY_RATING='$RATING'" >> $GITHUB_ENV
        echo "SAFETY_ISSUES=$SAFETY_ISSUES" >> $GITHUB_ENV
        echo "HIGH_RISK_ISSUES=$HIGH_RISK_ISSUES" >> $GITHUB_ENV
        echo "MEDIUM_RISK_ISSUES=$MEDIUM_RISK_ISSUES" >> $GITHUB_ENV
        echo "LOW_RISK_ISSUES=$LOW_RISK_ISSUES" >> $GITHUB_ENV
        echo "SECRETS_FOUND=$SECRETS_FOUND" >> $GITHUB_ENV
        echo "LICENSE_ISSUES=$LICENSE_ISSUES" >> $GITHUB_ENV

    # ==================== å¯è§†åŒ–æŠ¥å‘Šç”Ÿæˆ ====================
    - name: ç”Ÿæˆå®‰å…¨æ€åŠ¿å›¾
      run: |
        python3 <<EOF
        import matplotlib.pyplot as plt
        import numpy as np
        
        plt.rcParams['font.family'] = 'WenQuanYi Zen Hei'
        
        metrics = {
            'ä¾èµ–å®‰å…¨': int("$SAFETY_ISSUES"),
            'ä»£ç é£é™©': int("$HIGH_RISK_ISSUES") + int("$MEDIUM_RISK_ISSUES"),
            'æ•æ„Ÿä¿¡æ¯': int("$SECRETS_FOUND"),
            'è®¸å¯åˆè§„': int("$LICENSE_ISSUES")
        }
        
        labels = list(metrics.keys())
        values = list(metrics.values())
        angles = np.linspace(0, 2*np.pi, len(labels), endpoint=False)
        
        fig, ax = plt.subplots(figsize=(10,10), subplot_kw={'polar': True})
        ax.plot(np.append(angles, angles[0]), np.append(values, values[0]), 'b-', lw=2)
        ax.fill(np.append(angles, angles[0]), np.append(values, values[0]), 'b', alpha=0.1)
        ax.set_theta_offset(np.pi/2)
        ax.set_xticks(angles)
        ax.set_xticklabels(labels, fontsize=14)
        plt.savefig('security-radar.png', bbox_inches='tight', dpi=100)
        EOF

    # ==================== äº‘ç«¯å½’æ¡£é˜¶æ®µ ====================
    - name: é…ç½®è…¾è®¯äº‘å­˜å‚¨
      run: |
        coscmd config -a ${{ secrets.COS_SECRET_ID }} \
                     -s ${{ secrets.COS_SECRET_KEY }} \
                     -b ${{ secrets.COS_BUCKET }} \
                     -r ${{ secrets.COS_REGION }}

    - name: å½’æ¡£åˆ†æç»“æœ
      run: |
        DATE_PATH=$(date +"%Y%m%d")
        ARCHIVE_PATH="security-reports/${DATE_PATH}/run-${{ github.run_number }}"
        coscmd upload security-radar.png "${ARCHIVE_PATH}/security-radar.png"
        coscmd upload safety.json "${ARCHIVE_PATH}/safety.json"
        coscmd upload bandit.json "${ARCHIVE_PATH}/bandit.json"
        echo "REPORT_URL=https://pr.mizhoubaobei.top/${ARCHIVE_PATH}/security-radar.png" >> $GITHUB_ENV

    # ==================== å®¡æŸ¥ç»“æœåé¦ˆ ====================
    - name: æäº¤PRå®¡æŸ¥æŠ¥å‘Š
      uses: actions/github-script@v7
      env:
        REPORT_URL: ${{ env.REPORT_URL }}
        SCORE: ${{ env.SECURITY_SCORE }}
        RATING: ${{ env.SECURITY_RATING }}
        SAFETY_ISSUES: ${{ env.SAFETY_ISSUES }}
        HIGH_RISK_ISSUES: ${{ env.HIGH_RISK_ISSUES }}
        SECRETS_FOUND: ${{ env.SECRETS_FOUND }}
        LICENSE_ISSUES: ${{ env.LICENSE_ISSUES }}
      with:
        script: |
          const timestamp = new Date().getTime()
          const reportBody = `## ğŸ“Š ä»£ç å®‰å…¨å®¡æŸ¥æŠ¥å‘Š
          **ç»¼åˆå®‰å…¨è¯„åˆ†**: ${process.env.SCORE} ${process.env.RATING}

          ### å…³é”®æŒ‡æ ‡
          | æ£€æŸ¥é¡¹       | é—®é¢˜æ•°é‡ |
          |-------------|----------|
          | ä¾èµ–æ¼æ´    | ${process.env.SAFETY_ISSUES} |
          | é«˜å±ä»£ç é—®é¢˜ | ${process.env.HIGH_RISK_ISSUES} |
          | æ•æ„Ÿä¿¡æ¯æ³„éœ² | ${process.env.SECRETS_FOUND} |
          | è®¸å¯åè®®é—®é¢˜ | ${process.env.LICENSE_ISSUES} |

          [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](${process.env.REPORT_URL}?t=${timestamp})

          ![å®‰å…¨æ€åŠ¿å›¾](${process.env.REPORT_URL}?t=${timestamp})`

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: reportBody
          })

    # ==================== è´¨é‡é—¨ç¦æ§åˆ¶ ====================
    - name: æ‰§è¡Œè´¨é‡é—¨ç¦
      if: ${{ env.SECURITY_SCORE < 60 }}
      run: |
        echo "::error::ä»£ç å®‰å…¨è¯„åˆ†ä¸è¶³ï¼ˆå½“å‰ï¼š${{ env.SECURITY_SCORE }}/100ï¼‰ï¼Œè¯·ä¿®å¤é—®é¢˜åé‡æ–°æäº¤ï¼"
        exit 1