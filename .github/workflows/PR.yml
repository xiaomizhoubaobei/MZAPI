name: Python ä»£ç è´¨é‡ä¸å®‰å…¨å®¡æŸ¥æµæ°´çº¿å¢å¼ºç‰ˆ

on:
  pull_request:

jobs:
  security-check:
    name: "å®‰å…¨å®¡æŸ¥ - ${{ matrix.os }} Py${{ matrix.python-version }}"
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    timeout-minutes: 60
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    # ==================== åˆå§‹åŒ–é˜¶æ®µ ====================
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ==================== é…ç½®å‡†å¤‡é˜¶æ®µ ====================
    - name: åŠ è½½æ£€æŸ¥è§„åˆ™
      shell: bash
      run: |
        mkdir -p .github/linters
        [ -f .github/linters/flake8 ] || echo "[flake8]\nignore = E501,W503" > .github/linters/flake8
        ln -sf .github/linters/flake8 .flake8 || true
        ln -sf .github/linters/mypy.ini mypy.ini || true
        ln -sf .github/linters/pyproject.toml pyproject.toml || true

    # ==================== ç¯å¢ƒè®¾ç½®é˜¶æ®µ ====================
    - name: é…ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      shell: bash
      run: |
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          sudo apt-get update -qq
          sudo apt-get install -yq fonts-wqy-zenhei jq fontconfig
        elif [[ "${{ runner.os }}" == "macOS" ]]; then
          brew install jq
          fc-cache -fv
        elif [[ "${{ runner.os }}" == "Windows" ]]; then
          choco install jq -y
        fi

    - name: å®‰è£…åˆ†æå·¥å…·
      run: |
        python -m pip install --upgrade pip wheel
        pip install \
          flake8 \
          black \
          mypy \
          safety \
          bandit \
          pip-licenses \
          trufflehog3 \
          matplotlib \
          pandas \
          coscmd

        # éªŒè¯å…³é”®å·¥å…·
        bandit --version
        trufflehog3 --version


    # ==================== å®‰å…¨å®¡æŸ¥é˜¶æ®µ ====================
    - name: æ‰§è¡Œå®‰å…¨æ‰«æ
      if: ${{ matrix.is-main || matrix.os == 'ubuntu-latest' }}
      run: |
        # æ¸…ç†æ—§æŠ¥å‘Š
        rm -f ./*.json || true

        # ä¾èµ–å®‰å…¨æ£€æŸ¥
        pip freeze | safety check --stdin --output json > safety.json || echo '{"vulnerabilities": []}' > safety.json

        # ä»£ç æ¼æ´æ‰«æ
        bandit -r . -f json -o bandit.json --exclude tests,venv,.github || echo '{"results": []}' > bandit.json

        # æ•æ„Ÿä¿¡æ¯æ£€æµ‹
        trufflehog3 . -f json --max_depth 1 2>&1 | \
          grep '^{' | \
          jq -c '. | select(.Found == true)' | \
          jq -s '.' > trufflehog.json || echo '[]' > trufflehog.json

        # è®¸å¯è¯æ£€æŸ¥
        pip-licenses --format=json | \
          jq 'map(select(.License != null))' > licenses.json || echo '[]' > licenses.json

    # ==================== æ•°æ®éªŒè¯é˜¶æ®µ ====================
    - name: éªŒè¯æ‰«æç»“æœ
      if: ${{ matrix.is-main }}
      run: |
        validate_json() {
          local file=$1
          if ! jq empty "$file" 2>/dev/null; then
            echo "ä¿®å¤æ— æ•ˆçš„JSONæ–‡ä»¶: $file"
            case "$file" in
              *safety.json) echo '{"vulnerabilities": []}' > "$file" ;;
              *bandit.json) echo '{"results": []}' > "$file" ;;
              *) echo '[]' > "$file" ;;
            esac
          fi
        }

        validate_json safety.json
        validate_json bandit.json
        validate_json trufflehog.json
        validate_json licenses.json

    # ==================== å®‰å…¨è¯„åˆ†ç³»ç»Ÿ ====================
    - name: è®¡ç®—å®‰å…¨è¯„åˆ†
      if: ${{ matrix.is-main }}
      id: security-scoring
      run: |
        # æƒé‡é…ç½®ï¼ˆå¯è°ƒæ•´ï¼‰
        declare -A WEIGHTS=(
          [SAFETY]=10    # ä¾èµ–æ¼æ´
          [HIGH]=8       # é«˜å±é—®é¢˜
          [MEDIUM]=5     # ä¸­å±é—®é¢˜
          [LOW]=2        # ä½å±é—®é¢˜
          [SECRETS]=20   # æ•æ„Ÿä¿¡æ¯
          [LICENSE]=3    # è®¸å¯åè®®
        )

        # å®‰å…¨æ•°æ®é‡‡é›†
        SAFETY_ISSUES=$(jq '.vulnerabilities | length // 0' safety.json)
        HIGH_RISK_ISSUES=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length // 0' bandit.json)
        MEDIUM_RISK_ISSUES=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length // 0' bandit.json)
        LOW_RISK_ISSUES=$(jq '[.results[] | select(.issue_severity == "LOW")] | length // 0' bandit.json)
        SECRETS_FOUND=$(jq 'length // 0' trufflehog.json)
        LICENSE_ISSUES=$(jq 'map(select(.License | test("^MIT$|^Apache-2.0$|^BSD-")) | not) | length // 0' licenses.json)

        # è®¡ç®—æ€»æ‰£åˆ†
        TOTAL_DEDUCTION=$((
          SAFETY_ISSUES * WEIGHTS[SAFETY] +
          HIGH_RISK_ISSUES * WEIGHTS[HIGH] +
          MEDIUM_RISK_ISSUES * WEIGHTS[MEDIUM] +
          LOW_RISK_ISSUES * WEIGHTS[LOW] +
          SECRETS_FOUND * WEIGHTS[SECRETS] +
          LICENSE_ISSUES * WEIGHTS[LICENSE]
        ))

        # è®¡ç®—æœ€ç»ˆå¾—åˆ†
        FINAL_SCORE=$((100 - TOTAL_DEDUCTION))
        FINAL_SCORE=$((FINAL_SCORE < 0 ? 0 : FINAL_SCORE))

        # è¯„çº§ç³»ç»Ÿ
        RATING_SYSTEM=(
          "90:ğŸŸ¢ â˜…â˜…â˜…â˜…â˜…"
          "75:ğŸŸ¢ â˜…â˜…â˜…â˜…â˜†"
          "60:ğŸŸ¡ â˜…â˜…â˜…â˜†â˜†"
          "40:ğŸŸ  â˜…â˜…â˜†â˜†â˜†"
          "0:ğŸ”´ â˜…â˜†â˜†â˜†â˜†"
        )
        FINAL_RATING="ğŸ”´ â˜…â˜†â˜†â˜†â˜†"
        for level in "${RATING_SYSTEM[@]}"; do
          IFS=':' read -r threshold rating <<< "$level"
          if (( FINAL_SCORE >= threshold )); then
            FINAL_RATING="$rating"
            break
          fi
        done

        # è¾“å‡ºç¯å¢ƒå˜é‡
        echo "SECURITY_SCORE=$FINAL_SCORE" >> $GITHUB_ENV
        echo "SECURITY_RATING='$FINAL_RATING'" >> $GITHUB_ENV
        echo "SAFETY_ISSUES=$SAFETY_ISSUES" >> $GITHUB_ENV
        echo "HIGH_RISK_ISSUES=$HIGH_RISK_ISSUES" >> $GITHUB_ENV
        echo "MEDIUM_RISK_ISSUES=$MEDIUM_RISK_ISSUES" >> $GITHUB_ENV
        echo "LOW_RISK_ISSUES=$LOW_RISK_ISSUES" >> $GITHUB_ENV
        echo "SECRETS_FOUND=$SECRETS_FOUND" >> $GITHUB_ENV
        echo "LICENSE_ISSUES=$LICENSE_ISSUES" >> $GITHUB_ENV

    # ==================== å¯è§†åŒ–æŠ¥å‘Šç”Ÿæˆ ====================
    - name: ç”Ÿæˆå®‰å…¨æ€åŠ¿å›¾
      if: ${{ matrix.is-main }}
      run: |
        fc-cache -fv > /dev/null  # åˆ·æ–°å­—ä½“ç¼“å­˜
        
        python3 <<EOF
        import matplotlib.pyplot as plt
        import numpy as np
        from matplotlib import rcParams
        from matplotlib.font_manager import FontManager
        
        try:
            # è‡ªåŠ¨æ£€æµ‹ä¸­æ–‡å­—ä½“
            fm = FontManager()
            if any('WenQuanYi' in f.name for f in fm.ttflist):
                rcParams['font.family'] = 'WenQuanYi Zen Hei'
            else:
                rcParams['font.family'] = 'sans-serif'
            
            rcParams['axes.unicode_minus'] = False
            
            categories = ['ä¾èµ–å®‰å…¨', 'é«˜å±é—®é¢˜', 'ä¸­å±é—®é¢˜', 'æ•æ„Ÿä¿¡æ¯', 'è®¸å¯åˆè§„']
            values = [
                int("$SAFETY_ISSUES"),
                int("$HIGH_RISK_ISSUES"),
                int("$MEDIUM_RISK_ISSUES"),
                int("$SECRETS_FOUND"),
                int("$LICENSE_ISSUES")
            ]
            
            angles = np.linspace(0, 2 * np.pi, len(categories), endpoint=False).tolist()
            values += values[:1]
            angles += angles[:1]
            
            fig, ax = plt.subplots(figsize=(10, 10), subplot_kw={'polar': True})
            ax.fill(angles, values, 'b', alpha=0.1)
            ax.plot(angles, values, color='b', linewidth=2)
            
            ax.set_theta_offset(np.pi / 2)
            ax.set_theta_direction(-1)
            ax.set_thetagrids(np.degrees(angles[:-1]), categories)
            
            plt.title('å®‰å…¨æ€åŠ¿é›·è¾¾å›¾ - è¯„åˆ†: ${{ env.SECURITY_SCORE }}', pad=20)
            plt.savefig('security-radar.png', bbox_inches='tight', dpi=120)
        except Exception as e:
            print(f"å›¾è¡¨ç”Ÿæˆå¤±è´¥: {str(e)}")
            open('security-radar.png', 'a').close()
        EOF

    # ==================== é—®é¢˜åˆ—è¡¨ç”Ÿæˆé˜¶æ®µ ====================
    - name: ç”Ÿæˆè¯¦ç»†é—®é¢˜åˆ—è¡¨
      if: ${{ matrix.is-main }}
      run: |
        # ä¾èµ–å®‰å…¨é—®é¢˜
        echo "### ğŸ”§ ä¾èµ–æ¼æ´" > issues.md
        jq -r '.vulnerabilities[] | "- **\(.package_name)@\(.analyzed_version)**\n  - æ¼æ´ID: \(.vulnerability_id)\n  - æè¿°: \(.advisory)"' safety.json >> issues.md || echo "æ— ä¾èµ–æ¼æ´" >> issues.md

        # ä»£ç å®‰å…¨é—®é¢˜
        echo "\n### âš ï¸ ä»£ç é£é™©" >> issues.md
        jq -r '.results[] | "- **\(.issue_severity)çº§åˆ«** [\(.location.file)#è¡Œå·\(.location.line)]\n  - é—®é¢˜: \(.issue_text)\n  - ç½®ä¿¡åº¦: \(.issue_confidence)"' bandit.json >> issues.md || echo "æ— ä»£ç å®‰å…¨é—®é¢˜" >> issues.md

        # æ•æ„Ÿä¿¡æ¯
        echo "\n### ğŸ”‘ æ•æ„Ÿä¿¡æ¯æ£€æµ‹" >> issues.md
        jq -r '.[] | "- åœ¨ã€Œ\(.path)ã€å‘ç° \(.type)\n  - ç­¾å: \(.signature)\n  - ä¸Šä¸‹æ–‡: \(.context)"' trufflehog.json >> issues.md || echo "æœªå‘ç°æ•æ„Ÿä¿¡æ¯" >> issues.md

        # è®¸å¯è¯é—®é¢˜
        echo "\n### ğŸ“œ è®¸å¯è¯å¼‚å¸¸" >> issues.md
        jq -r '.[] | select(.License | test("^MIT$|^Apache-2.0$|^BSD-") | not) | "- **\(.Name)** ä½¿ç”¨éæ ‡å‡†åè®®: \(.License)"' licenses.json >> issues.md || echo "æ‰€æœ‰ä¾èµ–è®¸å¯è¯åˆè§„" >> issues.md

        # æ ¼å¼ä¼˜åŒ–
        sed -i 's/\([^ ]\)$/\1\n/g' issues.md

    # ==================== äº‘ç«¯å½’æ¡£é˜¶æ®µ ====================
    - name: é…ç½®è…¾è®¯äº‘å­˜å‚¨
      if: ${{ matrix.is-main }}
      run: |
        coscmd config -a ${{ secrets.COS_SECRET_ID }} \
                     -s ${{ secrets.COS_SECRET_KEY }} \
                     -b ${{ secrets.COS_BUCKET }} \
                     -r ${{ secrets.COS_REGION }} > /dev/null 2>&1

    - name: å½’æ¡£åˆ†æç»“æœ
      if: ${{ matrix.is-main }}
      run: |
        ARCHIVE_DIR="security-reports/$(date +"%Y%m%d")/run-${{ github.run_number }}"
        
        coscmd upload -f security-radar.png "${ARCHIVE_DIR}/security-radar.png" || echo "æ–‡ä»¶ä¸Šä¼ å¤±è´¥"
        coscmd upload -f safety.json "${ARCHIVE_DIR}/safety.json" || true
        coscmd upload -f bandit.json "${ARCHIVE_DIR}/bandit.json" || true
        
        echo "REPORT_URL=https://pr.mizhoubaobei.top/${ARCHIVE_DIR}/security-radar.png" >> $GITHUB_ENV

    # ==================== å®¡æŸ¥ç»“æœåé¦ˆ ====================
    - name: æäº¤PRå®¡æŸ¥æŠ¥å‘Š
      if: ${{ matrix.is-main }}
      uses: actions/github-script@v7
      env:
        SCORE: ${{ env.SECURITY_SCORE }}
        RATING: ${{ env.SECURITY_RATING }}
      with:
        script: |
          const fs = require('fs').promises;
          
          async function renderMarkdown(text) {
            const { data } = await github.rest.markdown.render({
              text: text,
              mode: 'gfm',
              context: context.repo.repo,
            });
            return data;
          }

          try {
            const issuesContent = await fs.readFile('issues.md', 'utf8');
            
            const fullReport = `
            ## ğŸ” ä»£ç å®‰å…¨å®¡æŸ¥æŠ¥å‘Š - ${process.env.RATING}
            **ç»¼åˆè¯„åˆ†**: ${process.env.SCORE}/100

            ### å®‰å…¨æŒ‡æ ‡æ¦‚è§ˆ
            | æ£€æŸ¥é¡¹         | é—®é¢˜æ•°é‡ |
            |---------------|----------|
            | ä¾èµ–æ¼æ´      | ${process.env.SAFETY_ISSUES} |
            | é«˜å±ä»£ç é—®é¢˜  | ${process.env.HIGH_RISK_ISSUES} |
            | ä¸­å±ä»£ç é—®é¢˜  | ${process.env.MEDIUM_RISK_ISSUES} |
            | æ•æ„Ÿä¿¡æ¯æ³„éœ²  | ${process.env.SECRETS_FOUND} |
            | è®¸å¯åè®®é—®é¢˜  | ${process.env.LICENSE_ISSUES} |

            ![å®‰å…¨æ€åŠ¿å›¾](${process.env.REPORT_URL}?t=${new Date().getTime()})

            ### é—®é¢˜è¯¦æƒ…æ¸…å•
            ${await renderMarkdown(issuesContent)}
            
            **æ‰«æè¯¦æƒ…**: [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](${process.env.REPORT_URL})
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: fullReport
            });
          } catch (error) {
            core.error(`æŠ¥å‘Šç”Ÿæˆå¤±è´¥: ${error}`);
            core.setFailed(error.message);
          }

    # ==================== è´¨é‡é—¨ç¦æ§åˆ¶ ====================
    - name: æ‰§è¡Œè´¨é‡é˜»æ–­
      if: ${{ matrix.is-main && env.SECURITY_SCORE < 60 }}
      run: |
        echo "::error::å®‰å…¨è¯„åˆ†ä¸è¶³ï¼ˆå½“å‰ï¼š${{ env.SECURITY_SCORE }}/100ï¼‰ï¼Œæœ€ä½é€šè¿‡åˆ†æ•°ä¸º60åˆ†"
        echo "é—®é¢˜æ‘˜è¦ï¼š"
        echo "- ä¾èµ–æ¼æ´: ${{ env.SAFETY_ISSUES }} ä¸ª"
        echo "- é«˜å±é—®é¢˜: ${{ env.HIGH_RISK_ISSUES }} ä¸ª"
        echo "- æ•æ„Ÿä¿¡æ¯: ${{ env.SECRETS_FOUND }} å¤„"
        exit 1