name: æ™ºèƒ½æ¶æ„åˆ†æå·¥ä½œæµ

on:
  pull_request:


jobs:
  architecture-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: ğŸ›  æ£€å‡ºPRåˆ†æ”¯ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 2
          submodules: recursive

      - name: ğŸ é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            graphviz \
            imagemagick \
            libxml2-dev \
            libxslt-dev \
            openjdk-17-jdk \
            snapd

          # å®‰è£…PlantUMLå¹¶é…ç½®ç¯å¢ƒ
          sudo snap install plantuml
          echo "PATH=$PATH:/snap/bin" >> $GITHUB_ENV

          # éªŒè¯å®‰è£…
          plantuml -version
          java -version

      - name: ğŸ§© å®‰è£…PythonåŒ…
        run: |
          pip install --upgrade pip
          pip install \
            pylint \
            pyreverse\
            matplotlib\
            qcloud-cos\
            pyyaml\
            pyan3

      - name: ğŸ” åŠ¨æ€å˜æ›´æ£€æµ‹
        id: changed-modules
        run: |
          git diff --name-only HEAD^ HEAD | grep -E 'MZAPI/MB/|src/' > changed_files.txt
          MODULE_PATHS=$(xargs dirname < changed_files.txt | sort -u | tr '\n' ' ')
          echo "modules=$MODULE_PATHS" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°å˜æ›´æ¨¡å—ï¼š$MODULE_PATHS"

      - name: ğŸ“Š ç”Ÿæˆæ¶æ„å›¾è°±
        env:
          TARGET_MODULES: ${{ steps.changed-modules.outputs.modules }}
        run: |
          # ç±»å›¾ç”Ÿæˆ
          pyreverse -o png -ASmn -p FullSystem $TARGET_MODULES
          
          # åŒ…ä¾èµ–å›¾
          pyreverse -k -o png -p Packages $TARGET_MODULES
          
          # æ—¶åºå›¾ç”Ÿæˆ
          find MB -name '*.py' | xargs pylint --generate-uml=sequence
          plantuml *.puml
          
          # è°ƒç”¨å…³ç³»å›¾
          pyan MB/**/*.py --uses --dot | dot -Tpng -o callgraph.png
          
          # ä»£ç çƒ­åº¦åˆ†æ
          git log --since="30 days ago" --pretty=format: --name-only | grep '\.py$' | sort | uniq -c > hotspots.txt
          python -c "
          import matplotlib.pyplot as plt
          data = [line.strip().split(maxsplit=1) for line in open('hotspots.txt')][:10]
          plt.figure(figsize=(10,6))
          plt.barh([x[1] for x in data], [int(x[0]) for x in data])
          plt.title('ä»£ç å˜æ›´çƒ­ç‚¹åˆ†å¸ƒ')
          plt.savefig('hotspots.png', bbox_inches='tight)
          "

          mkdir -p arch_assets
          mv *.png *.puml arch_assets/

      - name: â˜ï¸ ä¸Šä¼ è‡³è…¾è®¯äº‘COS
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
        run: |
          pip install coscmd
          coscmd config -a "$COS_SECRET_ID" -s "$COS_SECRET_KEY" -b "$COS_BUCKET" -r "$COS_REGION"

          PR_NUM=${{ github.event.pull_request.number }}
          SHORT_SHA=${GITHUB_SHA:0:7}
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%S")
          COS_PATH="ernie-arch/pr-$PR_NUM/$SHORT_SHA-$TIMESTAMP"

          coscmd upload -r arch_assets/ "$COS_PATH" \
            --acl public-read \
            -H "Cache-Control: no-cache"

          echo "ARCH_BASE_URL=https://pr.mizhoubaobei.top/$COS_PATH" >> $GITHUB_ENV

      - name: ğŸ’¬ ç”ŸæˆPRåˆ†ææŠ¥å‘Š
        uses: actions/github-script@v6
        env:
          DIAGRAM_BASE: ${{ env.ARCH_BASE_URL }}
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const newModules = [...new Set(
              files
                .filter(f => f.status === 'added' && f.filename.includes('MZAPI/MB/'))
                .map(f => f.filename.split('/')[3])
            )];

            const timestamp = Date.now();
            const commentBody = `
            ## ğŸ— ERNIE 4.0-8K æ¶æ„åˆ†ææŠ¥å‘Š

            ### æ ¸å¿ƒå¯è§†åŒ–
            <table>
              <tr>
                <td><img src="${process.env.DIAGRAM_BASE}/classes_FullSystem.png?ts=${timestamp}" width="400"></td>
                <td><img src="${process.env.DIAGRAM_BASE}/packages_Packages.png?ts=${timestamp}" width="400"></td>
              </tr>
              <tr>
                <td>ç±»ç»§æ‰¿å…³ç³»</td>
                <td>åŒ…ä¾èµ–ç»“æ„</td>
              </tr>
              <tr>
                <td><img src="${process.env.DIAGRAM_BASE}/callgraph.png?ts=${timestamp}" width="400"></td>
                <td><img src="${process.env.DIAGRAM_BASE}/hotspots.png?ts=${timestamp}" width="400"></td>
              </tr>
              <tr>
                <td>æ–¹æ³•è°ƒç”¨å…³ç³»</td>
                <td>ä»£ç çƒ­ç‚¹åˆ†å¸ƒ</td>
              </tr>
            </table>

            ${newModules.length > 0 ? `
            ### ğŸ†• æ–°å¢æ¨¡å—
            ${newModules.map(m => `- \`${m}\``).join('\n')}
            ` : ''}

            ### å˜æ›´å½±å“åˆ†æ
            **æ¶‰åŠæ–‡ä»¶**ï¼š
            ${files.filter(f => f.filename.startsWith('MZAPI/MB/')).map(f => `
            - \`${f.filename}\`  
              â–¸ çŠ¶æ€: ${f.status} | æ–°å¢è¡Œ: +${f.additions} | åˆ é™¤è¡Œ: -${f.deletions}`).join('\n')}

            <details>
            <summary>ğŸ“Œ ç‰ˆæœ¬æŒ‡çº¹ä¿¡æ¯</summary>

            | é¡¹ç›® | å€¼ |
            |---|---|
            | PRç¼–å· | #${context.issue.number} |
            | æäº¤å“ˆå¸Œ | \`${process.env.GITHUB_SHA}\` |
            | ç”Ÿæˆæ—¶é—´ | ${new Date().toISOString()} |
            | å­˜å‚¨è·¯å¾„ | [COSæµè§ˆå™¨](${process.env.DIAGRAM_BASE}) |
            </details>
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -rf arch_assets/
          find . -name '*.puml' -delete
          find . -name '*.dot' -delete