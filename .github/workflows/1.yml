name: Python ä»£ç è´¨é‡ä¸å®‰å…¨å®¡æŸ¥æµæ°´çº¿

on:
  pull_request:

jobs:
  å®‰å…¨ä¸è´¨é‡å®¡æŸ¥:
    name: "å®‰å…¨ä¸è´¨é‡å®¡æŸ¥ï¼ˆPythonï¼‰"
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    # ==================== åˆå§‹åŒ–é˜¶æ®µ ====================
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ==================== é…ç½®å‡†å¤‡é˜¶æ®µ ====================
    - name: åŠ è½½æ£€æŸ¥è§„åˆ™
      run: |
        mkdir -p .github/linters
        [ -f .github/linters/flake8 ] || touch .github/linters/flake8
        ln -sf .github/linters/flake8 .flake8 || true
        ln -sf .github/linters/mypy.ini mypy.ini || true
        ln -sf .github/linters/pyproject.toml pyproject.toml || true

    # ==================== ç¯å¢ƒè®¾ç½®é˜¶æ®µ ====================
    - name: é…ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei jq

    - name: å®‰è£…åˆ†æå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black mypy safety bandit \
                  pip-licenses trufflehog3 matplotlib \
                  pandas coscmd
        pip install -r requirements.txt

    # ==================== ä»£ç è´¨é‡å®¡æŸ¥é˜¶æ®µ ====================
    - name: æ‰§è¡Œä»£ç è§„èŒƒæ£€æŸ¥
      run: |
        echo "å¼€å§‹ä»£ç è§„èŒƒæ£€æŸ¥..."
        flake8 . --config .github/linters/flake8
        black --check . --config .github/linters/pyproject.toml
        mypy . --config-file .github/linters/mypy.ini

    # ==================== å®‰å…¨å®¡æŸ¥é˜¶æ®µ ====================
    - name: æ‰§è¡Œå®‰å…¨æ‰«æ
      run: |
        echo "å¯åŠ¨å®‰å…¨æ‰«æ..."
        pip freeze | safety check --stdin --output json > safety.json
        bandit -r . -f json -o bandit.json
        trufflehog filesystem --directory . --json > trufflehog.json
        pip-licenses --format=json > licenses.json

    # ==================== å®‰å…¨è¯„åˆ†ç³»ç»Ÿ ====================
    - name: è®¡ç®—å®‰å…¨è¯„åˆ†
      id: å®‰å…¨è¯„åˆ†
      run: |
        echo "æ­£åœ¨è®¡ç®—å®‰å…¨è¯„åˆ†..."
        å®‰å…¨æƒé‡=10
        é«˜å±æƒé‡=8
        ä¸­å±æƒé‡=5
        ä½å±æƒé‡=2
        æ•æ„Ÿæƒé‡=20
        è®¸å¯æƒé‡=3

        ä¾èµ–æ¼æ´æ•°=$(jq '.vulnerabilities | length' safety.json)
        é«˜å±é—®é¢˜æ•°=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit.json)
        ä¸­å±é—®é¢˜æ•°=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit.json)
        ä½å±é—®é¢˜æ•°=$(jq '[.results[] | select(.issue_severity == "LOW")] | length' bandit.json)
        æ•æ„Ÿä¿¡æ¯æ•°=$(jq 'length' trufflehog.json)
        è®¸å¯é—®é¢˜æ•°=$(jq 'map(select(.License | test("MIT|Apache|BSD") | not)) | length' licenses.json)

        æ€»æ‰£åˆ†=$((ä¾èµ–æ¼æ´æ•°*å®‰å…¨æƒé‡ + é«˜å±é—®é¢˜æ•°*é«˜å±æƒé‡ + ä¸­å±é—®é¢˜æ•°*ä¸­å±æƒé‡ + 
                ä½å±é—®é¢˜æ•°*ä½å±æƒé‡ + æ•æ„Ÿä¿¡æ¯æ•°*æ•æ„Ÿæƒé‡ + è®¸å¯é—®é¢˜æ•°*è®¸å¯æƒé‡))

        æœ€ç»ˆè¯„åˆ†=$((100 - æ€»æ‰£åˆ†))
        æœ€ç»ˆè¯„åˆ†=$((æœ€ç»ˆè¯„åˆ† < 0 ? 0 : æœ€ç»ˆè¯„åˆ†))

        if (( æœ€ç»ˆè¯„åˆ† >= 90 )); then è¯„çº§="ğŸŸ¢ â˜…â˜…â˜…â˜…â˜…"
        elif (( æœ€ç»ˆè¯„åˆ† >= 75 )); then è¯„çº§="ğŸŸ¢ â˜…â˜…â˜…â˜…â˜†"
        elif (( æœ€ç»ˆè¯„åˆ† >= 60 )); then è¯„çº§="ğŸŸ¡ â˜…â˜…â˜…â˜†â˜†"
        elif (( æœ€ç»ˆè¯„åˆ† >= 40 )); then è¯„çº§="ğŸŸ  â˜…â˜…â˜†â˜†â˜†"
        else è¯„çº§="ğŸ”´ â˜…â˜†â˜†â˜†â˜†"; fi

        echo "å®‰å…¨è¯„åˆ†=$æœ€ç»ˆè¯„åˆ†" >> $GITHUB_ENV
        echo "å®‰å…¨è¯„çº§='$è¯„çº§'" >> $GITHUB_ENV
        echo "SCORE=$æœ€ç»ˆè¯„åˆ†" >> $GITHUB_OUTPUT

    # ==================== å¯è§†åŒ–æŠ¥å‘Šç”Ÿæˆ ====================
    - name: ç”Ÿæˆå®‰å…¨æ€åŠ¿å›¾
      run: |
        echo "ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š..."
        python3 <<EOF
        import matplotlib.pyplot as plt
        import numpy as np
        
        plt.rcParams['font.family'] = 'WenQuanYi Zen Hei'
        
        æŒ‡æ ‡æ•°æ® = {
            'ä¾èµ–å®‰å…¨': int("$ä¾èµ–æ¼æ´æ•°"),
            'ä»£ç é£é™©': int("$é«˜å±é—®é¢˜æ•°") + int("$ä¸­å±é—®é¢˜æ•°"),
            'æ•æ„Ÿä¿¡æ¯': int("$æ•æ„Ÿä¿¡æ¯æ•°"),
            'è®¸å¯åˆè§„': int("$è®¸å¯é—®é¢˜æ•°")
        }
        
        æ ‡ç­¾ = list(æŒ‡æ ‡æ•°æ®.keys())
        æ•°å€¼ = list(æŒ‡æ ‡æ•°æ®.values())
        è§’åº¦ = np.linspace(0, 2*np.pi, len(æ ‡ç­¾), endpoint=False)
        
        å›¾å½¢, åæ ‡ç³» = plt.subplots(figsize=(10,10), subplot_kw={'polar': True})
        åæ ‡ç³».plot(np.append(è§’åº¦, è§’åº¦[0]), np.append(æ•°å€¼, æ•°å€¼[0]), 'b-', lw=2)
        åæ ‡ç³».fill(np.append(è§’åº¦, è§’åº¦[0]), np.append(æ•°å€¼, æ•°å€¼[0]), 'b', alpha=0.1)
        åæ ‡ç³».set_theta_offset(np.pi/2)
        åæ ‡ç³».set_xticks(è§’åº¦)
        åæ ‡ç³».set_xticklabels(æ ‡ç­¾, fontsize=14)
        plt.savefig('.github/å®‰å…¨æ€åŠ¿å›¾.png', bbox_inches='tight')
        EOF

    # ==================== äº‘ç«¯å½’æ¡£é˜¶æ®µ ====================
    - name: é…ç½®è…¾è®¯äº‘å­˜å‚¨
      run: |
        coscmd config -a ${{ secrets.COS_SECRET_ID }} \
                     -s ${{ secrets.COS_SECRET_KEY }} \
                     -b ${{ vars.COS_BUCKET }} \
                     -r ${{ vars.COS_REGION }}

    - name: å½’æ¡£åˆ†æç»“æœ
      run: |
        å½’æ¡£è·¯å¾„="å®‰å…¨æŠ¥å‘Š/$(date +%Yå¹´%mæœˆ)/${{ github.run_number }}"
        coscmd upload .github/å®‰å…¨æ€åŠ¿å›¾.png "$å½’æ¡£è·¯å¾„/å®‰å…¨æ€åŠ¿å›¾.png"
        coscmd upload safety.json "$å½’æ¡£è·¯å¾„/åŸå§‹æ•°æ®/ä¾èµ–å®‰å…¨.json"
        coscmd upload bandit.json "$å½’æ¡£è·¯å¾„/åŸå§‹æ•°æ®/ä»£ç é—®é¢˜.json"
        echo "æŠ¥å‘Šåœ°å€=https://pr.mizhoubaobei.top/$å½’æ¡£è·¯å¾„/å®‰å…¨æ€åŠ¿å›¾.png" >> $GITHUB_ENV

    # ==================== å®¡æŸ¥ç»“æœåé¦ˆ ====================
    - name: æäº¤PRå®¡æŸ¥æŠ¥å‘Š
      uses: actions/github-script@v7
      with:
        script: |
          const æŠ¥å‘Šå†…å®¹ = `
          ## ğŸ“Š ä»£ç å®‰å…¨å®¡æŸ¥æŠ¥å‘Š
          **ç»¼åˆå®‰å…¨è¯„åˆ†**: ${process.env.å®‰å…¨è¯„åˆ†} ${process.env.å®‰å…¨è¯„çº§}
          
          ### å…³é”®æŒ‡æ ‡
          | æ£€æŸ¥é¡¹       | é—®é¢˜æ•°é‡ |
          |-------------|----------|
          | ä¾èµ–æ¼æ´    | ${process.env.ä¾èµ–æ¼æ´æ•°} |
          | é«˜å±ä»£ç é—®é¢˜ | ${process.env.é«˜å±é—®é¢˜æ•°} |
          | æ•æ„Ÿä¿¡æ¯æ³„éœ² | ${process.env.æ•æ„Ÿä¿¡æ¯æ•°} |
          | è®¸å¯åè®®é—®é¢˜ | ${process.env.è®¸å¯é—®é¢˜æ•°} |
          
          [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](${process.env.æŠ¥å‘Šåœ°å€})
          
          ![å®‰å…¨æ€åŠ¿å›¾](${process.env.æŠ¥å‘Šåœ°å€}?${Date.now()})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: æŠ¥å‘Šå†…å®¹
          });

    # ==================== è´¨é‡é—¨ç¦æ§åˆ¶ ====================
    - name: æ‰§è¡Œè´¨é‡é—¨ç¦
      if: ${{ env.å®‰å…¨è¯„åˆ† < 60 }}
      run: |
        echo "::error::ä»£ç å®‰å…¨è¯„åˆ†ä¸è¶³ï¼ˆå½“å‰ï¼š${{ env.å®‰å…¨è¯„åˆ† }}/100ï¼‰ï¼Œè¯·ä¿®å¤é—®é¢˜åé‡æ–°æäº¤ï¼"
        exit 1