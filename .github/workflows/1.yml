name: æ™ºèƒ½æ¶æ„åˆ†æå·¥ä½œæµ

on:
  pull_request:

    types:
      - opened          # PRåˆ›å»º

jobs:
  architecture-analysis:
    name: å…¨é‡æ¶æ„åˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      pull-requests: write  # å…è®¸è¯„è®ºPR
      contents: read        # å…è®¸è¯»å–ä»£ç 

    steps:
      - name: ğŸ›  æ£€å‡ºPRåˆ†æ”¯ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}  # å…³è”PRåˆ†æ”¯
          fetch-depth: 2               # å¯ç”¨æ·±åº¦å…‹éš†ç”¨äºdiffåˆ†æ
          submodules: recursive        # åŒ…å«å­æ¨¡å—

      - name: ğŸ é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: 'pip'                 # å¯ç”¨pipç¼“å­˜åŠ é€Ÿ

      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            graphviz \          # å›¾è¡¨ç”Ÿæˆ
            plantuml \          # UMLæ¸²æŸ“
            imagemagick \       # å›¾ç‰‡å¤„ç†
            libxml2-dev \       # XMLè§£æ
            libxslt-dev         # XSLTè½¬æ¢

      - name: ğŸ§© å®‰è£…PythonåŒ…
        run: |
          pip install --upgrade pip
          pip install \
            pylint \         # ä»£ç åˆ†æ
            pyreverse \      # UMLç”Ÿæˆ
            matplotlib\     # çƒ­åº¦å›¾
            qcloud-cos\     # è…¾è®¯äº‘SDK
            plantuml\       # UMLæ¸²æŸ“
            pyyaml        # YAMLè§£æ

      - name: ğŸ” åŠ¨æ€å˜æ›´æ£€æµ‹
        id: changed-modules
        run: |
          # è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
          git diff --name-only HEAD^ HEAD > changed_files.txt
          
          # æå–MBæ¨¡å—å’Œsrcç›®å½•å˜æ›´
          MODULE_PATHS=$(grep -E 'MB/|src/' changed_files.txt | xargs dirname | sort -u)
          echo "modules=${MODULE_PATHS}" >> $GITHUB_OUTPUT
          
          # è°ƒè¯•è¾“å‡º
          echo "æ£€æµ‹åˆ°å˜æ›´æ¨¡å—ï¼š"
          echo "$MODULE_PATHS"

      - name: ğŸ“Š ç”Ÿæˆæ¶æ„å›¾è°±
        env:
          TARGET_MODULES: ${{ steps.changed-modules.outputs.modules }}
        run: |
          # ç±»ç»§æ‰¿å›¾
          pyreverse -o png -ASmn -p FullSystem $TARGET_MODULES
          
          # åŒ…ä¾èµ–å›¾
          pyreverse -k -o png -p Packages $TARGET_MODULES
          
          # æ—¶åºå›¾ç”Ÿæˆ
          find MZAPI/MB -name '*.py' | xargs pylint --generate-uml=sequence
          plantuml *.puml
          
          # è°ƒç”¨å…³ç³»å›¾
          pyan MZAPI/MB/**/*.py --uses --dot | dot -Tpng -o callgraph.png
          
          # ä»£ç çƒ­åº¦åˆ†æï¼ˆ30å¤©ï¼‰
          git log --since="30 days ago" --pretty=format: --name-only | grep '\.py$' | sort | uniq -c > hotspots.txt
          python -c "
          import matplotlib.pyplot as plt
          data = [line.strip().split(maxsplit=1) for line in open('hotspots.txt')][:10]
          plt.figure(figsize=(10,6))
          plt.barh([x[1] for x in data], [int(x[0]) for x in data])
          plt.title('ä»£ç å˜æ›´çƒ­ç‚¹åˆ†å¸ƒ')
          plt.savefig('hotspots.png', bbox_inches='tight')
          "

          # æ•´ç†äº§ç‰©
          mkdir -p arch_assets
          mv *.png *.puml arch_assets/

      - name: â˜ï¸ ä¸Šä¼ è‡³è…¾è®¯äº‘COS
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
        run: |
          pip install coscmd
          coscmd config -a "$COS_SECRET_ID" -s "$COS_SECRET_KEY" \
                       -b "$COS_BUCKET" -r "$COS_REGION"

          # æ„é€ è¯­ä¹‰åŒ–è·¯å¾„
          PR_NUM=${{ github.event.pull_request.number }}
          COS_PATH="ernie-arch/pr-$PR_NUM"

          # æ‰¹é‡ä¸Šä¼ å¹¶è®¾ç½®ç¼“å­˜ç­–ç•¥
          coscmd upload -r arch_assets/ "$COS_PATH" \
            --acl public-read \
            -H "Cache-Control: no-cache" \
            -H "x-cos-meta-commit: $GITHUB_SHA"

          # ç”Ÿæˆè®¿é—®é“¾æ¥
          echo "ARCH_BASE_URL=https://pr.mizhoubaobei.top/$COS_PATH" >> $GITHUB_ENV

      - name: ğŸ’¬ ç”ŸæˆPRåˆ†ææŠ¥å‘Š
        uses: actions/github-script@v6
        env:
          DIAGRAM_BASE: ${{ env.ARCH_BASE_URL }}
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // æå–æ–°å¢æ¨¡å—
            const newModules = [...new Set(
              files
                .filter(f => f.status === 'added' && f.filename.includes('MZAPI/MB/'))
                .map(f => f.filename.split('/')[3])  # æå–æ¨¡å—å
            )];

            // ç”Ÿæˆæ—¶é—´æˆ³é˜²ç¼“å­˜
            const timestamp = Date.now();
            
            // æ„å»ºMarkdownå†…å®¹
            const commentBody = `
            ## ğŸ— ERNIE 4.0-8K æ¶æ„åˆ†ææŠ¥å‘Š

            ### æ ¸å¿ƒå¯è§†åŒ–
            <table>
              <tr>
                <td><img src="${process.env.DIAGRAM_BASE}/classes_FullSystem.png?ts=${timestamp}" width="400"></td>
                <td><img src="${process.env.DIAGRAM_BASE}/packages_Packages.png?ts=${timestamp}" width="400"></td>
              </tr>
              <tr>
                <td align="center">ç±»ç»§æ‰¿å…³ç³»</td>
                <td align="center">åŒ…ä¾èµ–ç»“æ„</td>
              </tr>
              <tr>
                <td><img src="${process.env.DIAGRAM_BASE}/callgraph.png?ts=${timestamp}" width="400"></td>
                <td><img src="${process.env.DIAGRAM_BASE}/hotspots.png?ts=${timestamp}" width="400"></td>
              </tr>
              <tr>
                <td align="center">æ–¹æ³•è°ƒç”¨å…³ç³»</td>
                <td align="center">ä»£ç çƒ­ç‚¹åˆ†å¸ƒ</td>
              </tr>
            </table>

            ### å˜æ›´å½±å“åˆ†æ
            ${newModules.length > 0 ? 
              `ğŸ†• æ£€æµ‹åˆ°æ–°æ¨¡å—: ${newModules.map(m => `\`${m}\``).join(', ')}` : 
              'ğŸ“Œ æœ¬æ¬¡æœªæ–°å¢æ ¸å¿ƒæ¨¡å—'}
            
            **å—å½±å“æ–‡ä»¶**ï¼š
            ${files.filter(f => f.filename.startsWith('MZAPI/MB/')).map(f => `
            - \`${f.filename}\`  
              â–¸ çŠ¶æ€: ${f.status} | æ–°å¢è¡Œ: +${f.additions} | åˆ é™¤è¡Œ: -${f.deletions}`).join('\n')}

            ### ç‰ˆæœ¬ä¿¡æ¯
            <details>
            <summary>æŸ¥çœ‹è¯¦ç»†æŒ‡çº¹</summary>
            
            | é¡¹ç›® | å€¼ |
            |---|---|
            | PRç¼–å· | #${context.issue.number} |
            | æäº¤å“ˆå¸Œ | \`${process.env.GITHUB_SHA}\` |
            | ç”Ÿæˆæ—¶é—´ | ${new Date().toISOString()} |
            | å®Œæ•´æŠ¥å‘Š | [COSæµè§ˆå™¨æŸ¥çœ‹](${process.env.DIAGRAM_BASE}) |
            </details>
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -rf arch_assets/
          find . -name '*.puml' -delete
          find . -name '*.dot' -delete